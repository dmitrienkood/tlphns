<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        .sidebar {
            width: 30%;
            padding: 20px;
            background: #f8f9fa;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .main-content {
            width: 70%;
            padding: 20px;
        }
        .form-group {
             margin-bottom: 10px;
        }
        .sidebar button {
             margin-top: 10px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –∫–Ω–æ–ø–∫–∏ */
             margin-bottom: 20px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –∫–Ω–æ–ø–∫–∏ */
        }
        .result-card {
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        h1, h2 {
            text-align: center;
        }
        .toggle-btn {
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
        }
        .hidden {
            display: none;
        }
        @media (max-width: 768px) {
            .sidebar, .main-content {
                width: 100%;
            }
        }
        #ntOutput {
            transition: all 0.3s;
            border: 2px solid #ddd;
        }

        #ntOutput:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1 class="mb-4">üîé –ü–æ–∏—Å–∫</h1>
            <form method="post" id="searchForm" class="mb-4">
                <div class="form-group">
                    <div class="mb-3">
                        <label class="form-label">–ò–ù–ù:</label>
                        <input type="text" class="form-control" name="inn_org" required value="{{ inn_org if inn_org else '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–¢–°–ü:</label>
                        <input type="text" class="form-control" name="tsp" value="{{ tsp if tsp else '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–¢–ë:</label>
                        <input type="text" class="form-control" name="tb" value="{{ tb if tb else '' }}">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">üîç –ù–∞–π—Ç–∏</button>
                </div>
            </form>
        </div>

        <div class="main-content">
            <div id="loading" class="text-center mt-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <p>–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</p>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
            <div id="results"></div>
        </div>
    </div>

    <script>
        function toggleVisibility(id) {
            var element = document.getElementById(id);
            if (element.classList.contains("hidden")) {
                element.classList.remove("hidden");
            } else {
                element.classList.add("hidden");
            }
        }
    </script>

    <script>
        function clearFields() {
            document.querySelector('input[name="inn_org"]').value = "";
            document.querySelector('input[name="tsp"]').value = "";
            document.querySelector('input[name="tb"]').value = "";
        }
    </script>

    <script>
        document.getElementById("searchForm").addEventListener("submit", function(event) {
            event.preventDefault();  // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

            let formData = new FormData(this);

            document.getElementById("loading").style.display = "block";  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
            document.getElementById("results").innerHTML = "";  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

            fetch("/", {
                method: "POST",
                headers: { "X-Requested-With": "XMLHttpRequest" },  // –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è Flask
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById("loading").style.display = "none";  // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
                document.getElementById("results").innerHTML = html;  // –í—Å—Ç–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            })
            .catch(error => {
                document.getElementById("loading").style.display = "none";
                document.getElementById("results").innerHTML = "<p class='text-danger'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>";
            });
        });
    </script>

    <script>
        function mergePhones() {
            try {
                // –ü–∞—Ä—Å–∏–Ω–≥ –≤—Å–µ—Ö –Ω–æ–º–µ—Ä–æ–≤
                const tspPhones = parseTSPTB(document.querySelector('[name="tsp"]').value, '—Ç—Å–ø');
                const tbPhones = parseTSPTB(document.querySelector('[name="tb"]').value, '—Ç–±');
                const existingNtPhones = document.getElementById('ntOutput').value
                    .split("–Ω—Ç ")  // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ "–Ω—Ç "
                    .map(phone => phone.trim())  // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
                    .filter(phone => phone !== "");
                const manualPhones = parseNT(document.getElementById('manualInput').value);

                console.log("üìå –°–ø–∏—Å–æ–∫ existingNtPhones: ", existingNtPhones);
                console.log("üìå –°–ø–∏—Å–æ–∫ manualPhones: ", manualPhones);

                // –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
                const combinedPhones = [...existingNtPhones, ...manualPhones];

                console.log("üìå –ò—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫: ", combinedPhones);

                const filteredPhones = combinedPhones
                    .filter((phone, index, self) =>
                        self.indexOf(phone) === index &&
                        !tspPhones.includes(phone) &&
                        !tbPhones.includes(phone)
                    );

                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞
                document.getElementById('ntOutput').value =
                    filteredPhones.map(phone => `–Ω—Ç ${phone}`).join(' ');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        function parseNT(text) {
            return text.split(/\n\n+/)
                .map(item => {
                    let number = item
                        .replace(/\D/g, '') // –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä—ã
                        .replace(/^(\+7|7)/, '')
                        .slice(0, 10); // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 10 —Ü–∏—Ñ—Ä

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
                    return number.length === 10 &&
                           ['3','4','8','9'].includes(number[0]) ? number : null;
                })
                .filter(number => number !== null);
        }

        function parseTSPTB(text, prefix) {
            return text.split(/\n\n+/)
                .map(item => {
                    let number = item
                        .replace(new RegExp(prefix, 'gi'), '') // –£–¥–∞–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å
                        .replace(/\D/g, '') // –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä—ã
                        .replace(/^(\+7|7)/, '')
                        .slice(0, 10);

                    return number.length === 10 &&
                           ['3','4','8','9'].includes(number[0]) ? number : null;
                })
                .filter(number => number !== null);
        }
        </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
